<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>COCOA信号確認システム</title>
</head>

<body>
<h1>COCOA信号確認システム</h1>
  <p>
    接触確認アプリ(COCOA)が接触確認に用いる信号が発信されているか確認するシステムです。
  </p>
<hr>
  <p>
    <input type="button" id="btn_sysboot" value="COCOA信号確認システムを起動する" onclick="checker_boot();" /><br />
    <br />
    <span style="	font-size: xx-large; background-color: silver; font-weight: bold;" id="checker">信号確認システム停止中</span><br />
    <br />
    <input type="button" id="btn_confirm" style="color: white;" value="COCOAの信号を確認する" onclick="check_process_start();" disabled /><br />
    <br />
    <video id="video" loop muted>
      <source src="./assets/simple_movie.webm" type="video/webm">
    </video>
  </p>
<hr>
  <p>
    電波強度の変化の閾値：
    <select id="rssi-threshold">
      <option value="3"> 3dB </option>
      <option value="4"> 4dB </option>
      <option value="5"> 5dB </option>
      <option value="6"> 6dB </option>
      <option value="7"> 7dB </option>
      <option value="8"> 8dB </option>
      <option value="9"> 9dB </option>
      <option value="10" selected> 10dB </option>
    </select>
  </p>
<hr>
  <p>
    <a href="https://daisuke-nogami.github.io/cocoa-tools/">cocoa-toolsに戻る</a>
  </p>
<hr>
  <audio id="beep_sound" src="./assets/simple_beep.mp3">
    このブラウザでは検知音を鳴らすことが出来ません。
  </audio>
  <p>動作ログ <input type="checkbox" id="log_level" />出力する</p>
  <textarea id="log" cols="30" rows="10"></textarea>

<script>
var LEscanobject;            // Bluetooth LEスキャンをコントロールするためのobject
var timer_cleaner;           // タイマー(1)
var timer_start_check;       // タイマー(2)
var checker_shotdown;        // タイマー(3)
var check_process_ongoing = false; // リスナー(1)内で使うフラグ
var terminalrssi = [];       // 検知された端末の1秒ごとのRSSI平均値を記録
var detectcriteria = {};     // 端末の判定条件になるRSSI平均値を格納

// オフラインでのリロードに対応させるためのService Worker登録
/* 開発中で頻繁に更新するので一度コメントアウト
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./offline-cache-sw.js').then(function(registration) {
      // Registration was successful
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, function(err) {
      // registration failed :(
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
 */

// 動作ログへの文字出力
function log( text ) {
  var log_onoff = document.getElementById('log_level');
  if (log_onoff.checked){
    let log_div = document.getElementById('log');
    log_div.insertAdjacentText('beforeend', text + '\n');
  }
}

// リスナー(1)内の、信号確認時の処理を定義
function found_signal(nowtimestring, deviceid, type, threshold) {
  // リスナー(1)のフラグを下ろす
  check_process_ongoing = false;
  // 表示を変更
  document.getElementById('checker').innerText = "COCOAの信号を発信している端末を確認しました!";
  document.getElementById('checker').style.background = "aqua";
  // 検知音を再生する
  var s = document.getElementById('beep_sound');
  s.play();
  // タイマー④を一度解除してから、
  clearInterval(checker_shutdown);
  // 改めてタイマー④を15秒後に設定
  checker_shutdown = setTimeout(func_shutdown, 15000);

  log(nowtimestring
    + '\t 端末の信号を検知 found terminal. type: ' + type + ', id = ' + deviceid
    + 'detectcriteria: ' + detectcriteria[deviceid][type] + ' threshold: ' + threshold);
}

// リスナー(1)
function found_terminal(event) {
  // 現在時刻の取得
  var nowtime = new Date();
  var nowtimestring = nowtime.toLocaleTimeString('ja-JP');
  var timenumber = nowtime.getSeconds();
  // terminalrssiに計測結果を投入する
  // その時刻(秒)の計測結果投入がはじめてなら、連想配列を生成する
  if ( !terminalrssi[timenumber] ) {
    terminalrssi[timenumber] = {};
  }
  // event.device.idの値の有無を確認する
  if ( !terminalrssi[timenumber][event.device.id] ) {
    // 存在しない = 初発見なら、最初の値を入れる
    terminalrssi[timenumber][event.device.id] = {count: 1, value: event.rssi};
  } else {
    // 存在するなら、値を修正する
    terminalrssi[timenumber][event.device.id] = {
      count: terminalrssi[timenumber][event.device.id].count + 1,
      value: terminalrssi[timenumber][event.device.id].value + event.rssi
    };
  }
  // ログ表示する
  log(nowtimestring
    + '\t added terminalrssi. id = ' + event.device.id
    + ', count = ' + terminalrssi[timenumber][event.device.id].count
    + ', value = ' + terminalrssi[timenumber][event.device.id].value
    + ', average = ' + terminalrssi[timenumber][event.device.id].value / terminalrssi[timenumber][event.device.id].count );

  // もしフラグが立っていたら
  if ( check_process_ongoing ) {
    // 閾値を取得する
    //var threshold = document.getElementById('rssi-threshold').options[document.getElementById('rssi-threshold').selectedIndex].value;
    const threshold = 10;
    // 発見した端末がdetectcriteriaを満たしているか確認する

    // 計測ボタン押下直前の値との比較
    if ( detectcriteria[event.device.id].before_average ) {
      if ( (terminalrssi[timenumber][event.device.id].value / terminalrssi[timenumber][event.device.id].count)
           >= (detectcriteria[event.device.id].before_average + threshold) ) {
             found_signal(nowtimestring, event.device.id, "before_average", threshold)
           }
    }
    // 計測開始表示直前の値との比較
    if ( detectcriteria[event.device.id].first_average ) {
      if ( (terminalrssi[timenumber][event.device.id].value / terminalrssi[timenumber][event.device.id].count)
           >= (detectcriteria[event.device.id].first_average + threshold) ) {
             found_signal(nowtimestring, event.device.id, "first_average", threshold)
           }
    }
  }
}

// タイマー(1) 10秒前~11秒前の変数を空にする
function func_cleaner(){
  // 変数の中身を空にするルーチン
  function func_assoc_array(num) {
    if ( !terminalrssi[num] ) {
      // 中身が存在しなければ、なにもしない
      log(nowtimestring + '\t timenumber = ' + num + ' is undefined.');
    } else if ( Object.keys(terminalrssi[num]).length == 0) {
      // 中身が空っぽでも、何もしない
      log(nowtimestring + '\t timenumber = ' + num + ' is empty.');
    } else {
      // 中身があるので、空にする
      terminalrssi[num] = {};
      log(nowtimestring + '\t timenumber = ' + num + ' is not empty, clear it.');
    }
  }
  // 現在時刻の取得
  var nowtime = new Date();
  var nowtimestring = nowtime.toLocaleTimeString('ja-JP');
  // 10秒前の時刻を得て、変数の中身を空にする
  nowtime.setSeconds(nowtime.getSeconds() - 10);
  func_assoc_array(nowtime.getSeconds());
  // 11秒前の時刻を得て、変数の中身を空にする
  nowtime.setSeconds(nowtime.getSeconds() - 1);
  func_assoc_array(nowtime.getSeconds());
}

// イベント(1) COCOA信号確認システムを起動する
async function checker_boot() {
    // 現在時刻の取得
    var nowtime = new Date();
    var nowtimestring = nowtime.toLocaleTimeString('ja-JP');
    // スキャン確認のポップアップを押さなかったときにタイムアウトさせる関数を書く
    const timeout_promise = new Promise((resolve, reject) => {
        setTimeout(reject, 10000);
    });
    try{
        log(nowtimestring + '\t checker_boot(); COCOA信号確認システムを起動します');
        // スキャンを開始する
        LEscanobject = await Promise.race([
            navigator.bluetooth.requestLEScan({filters: [{ services: [0xFD6F]}]}),
            timeout_promise
        ]);
        // リスナー(1)を設定する
        navigator.bluetooth.addEventListener('advertisementreceived', found_terminal );
        // タイマー(1)を設定する
        timer_cleaner = setInterval(func_cleaner,1000);
        // ボタン btn_confirm を操作可能にする
        document.getElementById('btn_confirm').removeAttribute("disabled");
        document.getElementById('btn_confirm').style.color = "black";
        // ボタン btn_sysboot を操作不能にする
        document.getElementById('btn_sysboot').setAttribute("disabled", true);
        document.getElementById('btn_sysboot').style.color = "White";
        // 操作可能になったことを表示する
        document.getElementById('checker').innerText = "信号確認をするには [COCOAの信号を確認する] ボタンを押してください";
        document.getElementById('checker').style.background = "yellow";
        // 動画を再生して画面Offを抑止する
        var v = document.getElementById('video');
        v.play();
    } catch (error) {
        log('ERR: エラーがおきました : ' + error);
    }
}

// タイマー(3)
function func_shutdown(){
  // 表示を初期状態に戻す 信号確認システム停止中
  document.getElementById('checker').innerText = "信号確認システム停止中";
  document.getElementById('checker').style.background = "silver";
  // ボタン btn_confirm を操作可能にする
  document.getElementById('btn_confirm').removeAttribute("disabled");
  document.getElementById('btn_confirm').style.color = "black";
}

// タイマー(2)
function func_start_check(){
  // 現在時刻の取得
  var nowtime = new Date();
  var nowtimestring = nowtime.toLocaleTimeString('ja-JP');
  // 初期値(first_average)を計算して detectcriteria へ投入する
  // 初期値の計算対象時刻となる秒番号を取得する
  var timenumber1 = nowtime.getSeconds()-1;   // 1秒前
  nowtime.setSeconds(nowtime.getSeconds()-1); // 1秒戻して
  var timenumber2 = nowtime.getSeconds()-1;   // 更に1秒前(=2秒前)
  // 初期値を計算するための仮の連想配列を作る
  var tmp_terminal_list = {};
  // 1秒前のterminalrssiを一通り回す
  for (const deviceid1 in terminalrssi[timenumber1]) {
    tmp_terminal_list[deviceid1] = {
      count: terminalrssi[timenumber1][deviceid1].count,
      value: terminalrssi[timenumber1][deviceid1].value
    }
  }
  // 2秒前のterminalrssiを一通り回して
  for (const deviceid2 in terminalrssi[timenumber2]) {
    if (!tmp_terminal_list[deviceid2]) {
      // もし1秒前のterminalrssiを回したときに未出なら追加し
      tmp_terminal_list[deviceid2] = {
        count: terminalrssi[timenumber2][deviceid2].count,
        value: terminalrssi[timenumber2][deviceid2].value
      }
    } else {
      // 既出なら数値を足す
      tmp_terminal_list[deviceid2] = {
        count: tmp_terminal_list[deviceid2].count +
          terminalrssi[timenumber2][deviceid2].count,
        value: tmp_terminal_list[deviceid2].value +
          terminalrssi[timenumber2][deviceid2].value
      }
    }
  }
  // tmp_terminal_listを回し、2つ目の初期値(first_average)を計算して detectcriteria へ投入する
  for (const deviceids in tmp_terminal_list) {
    if ( !detectcriteria[deviceids] ) {
      // detectcriteriaに当該端末がなければ連想配列の入れ物を追加する
      detectcriteria[deviceids] = {};
    }
    // 値を計算して投入する
    detectcriteria[deviceids].first_average = tmp_terminal_list[deviceids].value / tmp_terminal_list[deviceids].count;
  }
  log(nowtimestring + '\t func_start_check(); 信号確認準備完了、初期値あり端末数は' + Object.keys(detectcriteria).length + ' 個');
  // 表示を変更（計測したい端末を近づけてください）
  document.getElementById('checker').innerText = "信号確認の準備が出来ました、計測したい端末を近づけてください";
  document.getElementById('checker').style.background = "green";
  // リスナー(1)のフラグを立てる
  check_process_ongoing = true;
  // タイマー(3)を30秒後に設定 (settimeout )
  checker_shutdown = setTimeout(func_shutdown, 30000)
}

// イベント(2) 計測開始準備を始める
function check_process_start(){
  // 現在時刻の取得
  var nowtime = new Date();
  var nowtimestring = nowtime.toLocaleTimeString('ja-JP');
  // 表示を変更（準備が出来るまでお待ちください）
  document.getElementById('checker').innerText = "信号確認の準備が出来るまで、4秒ほどお待ちください";
  document.getElementById('checker').style.background = "yellow";
  // ボタン btn_confirm を操作不能にする
  document.getElementById('btn_confirm').setAttribute("disabled", true);
  document.getElementById('btn_confirm').style.color = "White";
  // 初期値の計算対象時刻となる秒番号を取得する
  var timenumber1 = nowtime.getSeconds()-1;   // 1秒前
  nowtime.setSeconds(nowtime.getSeconds()-1); // 1秒戻して
  var timenumber2 = nowtime.getSeconds()-1;   // 更に1秒前(=2秒前)
  // 初期値を計算するための仮の連想配列を作る
  var tmp_terminal_list = {};
  // 1秒前のterminalrssiを一通り回す
  for (const deviceid1 in terminalrssi[timenumber1]) {
    tmp_terminal_list[deviceid1] = {
      count: terminalrssi[timenumber1][deviceid1].count,
      value: terminalrssi[timenumber1][deviceid1].value
    }
  }
  // 2秒前のterminalrssiを一通り回して
  for (const deviceid2 in terminalrssi[timenumber2]) {
    if (!tmp_terminal_list[deviceid2]) {
      // もし1秒前のterminalrssiを回したときに未出なら追加し
      tmp_terminal_list[deviceid2] = {
        count: terminalrssi[timenumber2][deviceid2].count,
        value: terminalrssi[timenumber2][deviceid2].value
      }
    } else {
      // 既出なら数値を足す
      tmp_terminal_list[deviceid2] = {
        count: tmp_terminal_list[deviceid2].count +
          terminalrssi[timenumber2][deviceid2].count,
        value: tmp_terminal_list[deviceid2].value +
          terminalrssi[timenumber2][deviceid2].value
      }
    }
  }
  // detectcriteriaを空にする
  detectcriteria = {};
  // 仕上がったtmp_terminal_listを一通り回し初期値(before_average)を計算して detectcriteria へ投入する
  for (const deviceids in tmp_terminal_list) {
    detectcriteria[deviceids] = {};
    detectcriteria[deviceids].before_average = tmp_terminal_list[deviceids].value / tmp_terminal_list[deviceids].count;
  }
  log(nowtimestring + '\t check_process_start(); 信号確認準備に入る、初期値あり端末数は' + Object.keys(detectcriteria).length + ' 個');
  // タイマー(2)を4秒後に設定する
  timer_start_check = setTimeout(func_start_check,4000);
}
</script>
</body>
</html>
